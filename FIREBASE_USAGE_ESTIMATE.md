# Firebase 使用量の見積もり（無料プラン）

## Firebase Spark Plan（無料プラン）の制限

### Firestore

- **読み取り**: 50,000回/日
- **書き込み**: 20,000回/日
- **削除**: 20,000回/日
- **ストレージ**: 1 GB
- **ネットワーク**: 10 GB/月

---

## 現在の実装での使用量シミュレーション

### 🔴 問題: リアルタイム同期が常時全コレクションを監視

現在の実装では、以下の4つのコレクションを**常時リアルタイム監視**しています:

- `projects` コレクション
- `chapters` コレクション
- `scenes` コレクション
- `characters` コレクション

#### リアルタイム同期のコスト（onSnapshot）

Firestoreの`onSnapshot()`は以下のタイミングで読み取りが発生します:

1. **初回接続時**: コレクション内の全ドキュメントを読み取り
2. **変更があった時**: 変更されたドキュメントのみ読み取り
3. **再接続時**: コレクション内の全ドキュメントを再度読み取り

---

## 📊 具体的な使用量計算

### シナリオ1: 小規模プロジェクト（1人で使用）

**データ構成:**

- プロジェクト: 3個
- 章/プロジェクト: 10個 → 合計30章
- シーン/章: 5個 → 合計150シーン
- キャラクター: 10個
- **合計ドキュメント数: 193個**

**1日の使用パターン（8時間執筆）:**

| 操作                                 | 回数 | 読み取り  | 書き込み | 削除  |
| ------------------------------------ | ---- | --------- | -------- | ----- |
| アプリ起動（全コレクション読み込み） | 3回  | **579**   | 0        | 0     |
| リアルタイム同期（変更時）           |      |           |          |       |
| - シーン編集                         | 50回 | 50        | 50       | 0     |
| - 章タイトル変更                     | 5回  | 5         | 5        | 0     |
| - キャラクター編集                   | 3回  | 3         | 3        | 0     |
| - プロジェクト更新（自動）           | 58回 | 0         | 58       | 0     |
| 新規作成                             |      |           |          |       |
| - 新しいシーン                       | 2回  | 2         | 2        | 0     |
| - 新しい章                           | 1回  | 1         | 1        | 0     |
| ネットワーク切断→再接続              | 2回  | **386**   | 0        | 0     |
| **合計**                             |      | **1,026** | **119**  | **0** |

**無料枠に対する使用率:**

- 読み取り: **2.05%** (1,026 / 50,000)
- 書き込み: **0.60%** (119 / 20,000)

✅ **結果: 余裕で無料枠内**

---

### シナリオ2: 中規模プロジェクト（1人で使用、長編小説）

**データ構成:**

- プロジェクト: 5個
- 章/プロジェクト: 50個 → 合計250章
- シーン/章: 10個 → 合計2,500シーン
- キャラクター: 50個
- **合計ドキュメント数: 2,805個**

**1日の使用パターン（10時間執筆）:**

| 操作                                 | 回数    | 読み取り   | 書き込み  | 削除  |
| ------------------------------------ | ------- | ---------- | --------- | ----- |
| アプリ起動（全コレクション読み込み） | 4回     | **11,220** | 0         | 0     |
| リアルタイム同期（変更時）           |         |            |           |       |
| - シーン編集                         | 100回   | 100        | 100       | 0     |
| - 自動保存（30秒ごと）               | 1,200回 | 0          | 1,200     | 0     |
| - プロジェクト更新（自動）           | 100回   | 0          | 100       | 0     |
| ネットワーク切断→再接続              | 5回     | **14,025** | 0         | 0     |
| **合計**                             |         | **25,345** | **1,400** | **0** |

**無料枠に対する使用率:**

- 読み取り: **50.69%** (25,345 / 50,000)
- 書き込み: **7.00%** (1,400 / 20,000)

⚠️ **結果: 読み取りが半分消費、制限に注意が必要**

---

### シナリオ3: 複数ユーザー（5人で共同編集）

**データ構成:**

- プロジェクト: 10個（共有）
- 章: 500個
- シーン: 5,000個
- キャラクター: 100個
- **合計ドキュメント数: 5,610個**

**1日の使用パターン（各ユーザー5時間ずつ）:**

| 操作                                 | 回数    | 読み取り    | 書き込み  | 削除  |
| ------------------------------------ | ------- | ----------- | --------- | ----- |
| アプリ起動（各ユーザー×3回）         | 15回    | **84,150**  | 0         | 0     |
| リアルタイム同期（各ユーザーの変更） |         |             |           |       |
| - 各ユーザーの編集                   | 500回   | 500         | 500       | 0     |
| - 自動保存                           | 3,000回 | 0           | 3,000     | 0     |
| - プロジェクト更新                   | 500回   | 0           | 500       | 0     |
| ネットワーク切断→再接続              | 10回    | **56,100**  | 0         | 0     |
| **合計**                             |         | **140,750** | **4,000** | **0** |

**無料枠に対する使用率:**

- 読み取り: **281.5%** ❌ **超過!**
- 書き込み: **20.0%** (4,000 / 20,000)

🔴 **結果: 読み取りが無料枠を大幅に超過（2.8倍）**

---

## 🚨 主な問題点

### 1. **onSnapshot が全コレクションを監視**

- 起動するたびに全ドキュメントを読み込む
- データが増えるほど比例してコストが増加
- 複数デバイスで開くと、その度に全読み込み

### 2. **不要なリアルタイム監視**

- 全てのプロジェクトの全てのシーンを常時監視
- 実際には現在編集中のプロジェクトだけで十分

### 3. **自動保存の頻度**

- 30秒ごとの自動保存は書き込みコストが高い
- 変更がない場合も保存している可能性

### 4. **ネットワーク再接続時の全読み込み**

- スリープ復帰、WiFi切り替え時に全データ再取得
- モバイル環境では頻繁に発生する可能性

---

## 💡 最適化案

### 優先度1: リアルタイム監視の範囲を制限 ⭐⭐⭐

```typescript
// ❌ 現在: 全コレクションを監視
setupRealtimeSync('scenes', ...)

// ✅ 改善: 現在のプロジェクトのみ監視
setupRealtimeSync('scenes',
  query(collection(db, 'scenes'),
    where('projectId', '==', currentProjectId)
  )
)
```

**削減効果:**

- シーン: 5,000個 → 500個（10分の1）
- 章: 500個 → 50個（10分の1）
- 読み取り: 84,150 → 8,415（**90%削減**）

### 優先度2: 差分同期の実装 ⭐⭐⭐

```typescript
// ✅ 最終同期時刻以降の変更のみ取得
const lastSync = localStorage.getItem('lastSyncTime');
query(
	collection(db, 'scenes'),
	where('updatedAt', '>', lastSync),
	where('projectId', '==', currentProjectId)
);
```

**削減効果:**

- 起動時の読み取り: 5,610個 → 10-50個（**95-99%削減**）

### 優先度3: バッチ書き込みの最適化 ⭐⭐

```typescript
// ✅ 変更があった場合のみ保存
if (hasChanges) {
  await syncToFirestore(...)
}

// ✅ デバウンス処理（3秒後に保存）
const debouncedSave = debounce(syncToFirestore, 3000);
```

**削減効果:**

- 自動保存: 1,200回 → 100-200回（**80-90%削減**）

### 優先度4: キャッシュの活用 ⭐

```typescript
// ✅ Firestoreのキャッシュを有効化
enableIndexedDbPersistence(db);

// ✅ 初回のみサーバーから取得、以降はキャッシュ
getDocs(query, { source: 'cache' });
```

**削減効果:**

- 再接続時の読み取り: 5,610個 → 0個（**100%削減**）

---

## 📈 最適化後の見積もり（複数ユーザー）

| 項目             | 最適化前    | 最適化後  | 削減率      |
| ---------------- | ----------- | --------- | ----------- |
| 起動時読み取り   | 84,150      | 1,000     | **98.8%** ↓ |
| 再接続読み取り   | 56,100      | 500       | **99.1%** ↓ |
| 自動保存書き込み | 3,000       | 300       | **90.0%** ↓ |
| **合計読み取り** | **140,750** | **2,000** | **98.6%** ↓ |
| **合計書き込み** | **4,000**   | **800**   | **80.0%** ↓ |

**無料枠に対する使用率（最適化後）:**

- 読み取り: **4.0%** (2,000 / 50,000) ✅
- 書き込み: **4.0%** (800 / 20,000) ✅

---

## ✅ 推奨アクション

1. **今すぐ実装すべき:**
   - 現在のプロジェクトのみリアルタイム監視
   - 差分同期の実装
   - 自動保存のデバウンス（3-5秒）

2. **中期的に実装:**
   - オフラインファースト設計（ローカル優先）
   - Firestoreキャッシュの活用
   - プロジェクト単位での同期制御

3. **運用上の注意:**
   - 1プロジェクトあたりのシーン数を500個以下に推奨
   - 複数プロジェクトを同時に開かない
   - 不要なプロジェクトは定期的にアーカイブ

---

## 📝 結論

### 現状のまま使用した場合:

- **1人使用**: 問題なし（余裕あり）
- **5人共同編集**: **無料枠超過の危険性が高い**

### 最適化を実装した場合:

- **1人使用**: 非常に余裕あり（1%未満）
- **5人共同編集**: 問題なく使用可能（4%程度）

**最適化は必須** です。特に「現在のプロジェクトのみ監視」と「差分同期」は、実装しないと複数人での使用やデータ増加に対応できません。
